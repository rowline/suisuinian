# Changelog (碎碎念 - 近期重构与优化记录)

## 📌 记录人：Antigravity (AI 协作助手)
## 📅 日期：2026年02月28日

### 🧠 核心架构演进：OpenClaw 隐私沙盒与知识库隔离
* **彻底解决“全局扫描”隐私危机**：
  * **问题背景**：OpenClaw 作为强大的 Agent 会默认开启所有工具，导致其由于没有边界限制而扫描了用户全盘的隐私文件，回复偏题且极度不安全。
  * **解决方案**：
    1. **画地为牢**：在代理端新建了 `/suisuinian-knowledge` 专属隔离区。
    2. **执行隔离**：强行锁定了 OpenClaw 的 `cwd`（当前工作目录）为该隔离区，并注入了极其严格的 **System Prompt（沙盒指令）**，严禁其动用底层搜索工具走出该范围。
    3. **自动同步**：新增了后台自动同步机制，用户在手机端生成的每一张转录凭据，都会被后台自动复制一份到知识库内，确保留音信息的绝对私有与可用。

### 📱 交互革命：首页 UI 重构与 PTT (Push-to-Talk) 全局搜索
* **从“记录工具”向“智能大脑中心”的转型**：
  * **UI 瘦身**：移除了顶部导航栏所有冗余 AI 入口，将操作重心全部下沉。
  * **PTT 手势化交互**：首页中心麦克风现已支持 **“长按说话，松开即搜”** 的丝滑体验。后台在松开的一瞬间会联动 ASR 直接将转录结果投喂给全局 AI。
  * **双重模式**：增加了专门的长录音模式（红色按钮）和随手记文本搜索输入框，满足不同场景下的快速查询需求。

### 🗒️ 功能增强：日报与聊天记录的全生命周期持久化
* **日报离线化与增量生成**：
  * 为 `DailyReport` 增加了本地磁盘 JSON 持久化。现在生成的日报会自动存放在沙盒的 `DailyReports` 文件夹。
  * 优化了加载逻辑，如果今日已有日报则直接展示缓存，极大优化了响应速度和本地算力消耗。
* **全局对话链路优化**：
  * 移除了冗余的网络请求荷载。现在 iOS 端发送请求时由于后台已掌控知识库，不再需要发送庞大的文本上下文，极大地提升了稳定性并降低了内存波动。

### 🚀 核心优化：多说话人识别（Diarization）精度史诗级提升
* **弃用语句级合并，采用词级精准碰撞**：
  * **问题背景**：以往的算法是将 Whisper 吐出的长达数十秒的“整段句子”与 Pyannote（说话人识别）进行盲目匹配，这就导致即使这十几秒内有 3 个人在频繁插嘴，最终也只能将这一大段话强行归结给这段时间内“说话最多”的那一个人，彻底丢失了另外的人。
  * **重构方案**：在 `transcribe_and_diarize.py` 中，全面启用了 `word_timestamps=True`（基于词级别的强制对齐）。现在，系统会将 Whisper 识别出的**每一个汉字或词组**，精确到毫秒级地去碰撞对应的发音人轨道，最后再将同属于一名发言人的连续词语无缝拼接成气泡，实现了极速对话场景下的**毫秒级精准断句排版**。

### 🎓 核心优化：高阶中文识别（ASR）退火算子与提示词工程调优
* **强制识别领域锁定与抗幻觉**：
  * **问题背景**：遇到中英文混杂、方言或环境噪音时，Whisper 有可能会“发懵”或进入幻觉状态，出现一大段重复文本、繁体字，或者把方言识别成奇怪的拼写。
  * **调优方案**：在 Python 脚本中增加了极为强势的超参数：
    1. 强制绑定 `language="zh"`（锁定内核为中文普通话）。
    2. 加入人工设计的超长 `initial_prompt` 提示词引子（“这是一段非常清晰的中文普通话商务会议...”），对术语、标点和口语化进行了强暗示。
    3. 加入深度 `temperature=(0.0, 0.2, ... 1.0)` 退火回退算法。当首遍识别置信度过低时，强制模型改变核采样的“温度”进行深入重试，极大降低了对会议录音的识别错误率 (WER)。

### 💾 新特性：AI 对话上下文与历史记录实现真正“本地持久化”
* **修复了杀后台 / 重新打开 App 聊天记录全军覆没的 Bug**：
  * **问题背景**：以前的 `ChatMessage` 没有打标 `Codable` 序列化协议，用户一旦关闭详情页，刚才和 OpenClaw 的精妙对谈就灰飞烟灭了。而且由于缺少本地序列化，旧版的缓存机制经常读错格式。
  * **解决方案**：在 iOS 端完成了底层数据结构重构，对聊天记录 (`.chat` 文件) 与结构化转录文本 (`.transcript` 文件) 都实现了**沙盒本地落盘化存储**。现在再次打开之前录音，转录不仅瞬间复原，而且所有的 AI 分析记录也会原封不动地排版在你面前！

### 🛡️ 错误阻断与系统鲁棒性修复
* **穿透缓存的“强制重洗”指令 (Force Re-Transcribe)**：
  * 彻底修复了点击“重新转译”按钮时，Node 服务端“自作主张”偷偷返回本地域内废旧缓存的问题。通过 iOS 与 Node 双端联调，新增了强有力的 `force: true` API 握手参数，确保只要你点下按钮，后台一定不偷懒，硬生生拉起底层显卡重新运算！
* **屏蔽 PyTorch/Torchaudio 底层控制台“废话警告”引起的 500 宕机**：
  * `torchaudio` 版本由于老旧，老在 Mac 控制台上乱打印废弃警告，导致我们的 Node 代理抓取 JSON 排版结果时提取了一堆垃圾乱码而崩溃（App甚至会因此绝望地启用难看的苹果自带单机离线听写）。
  * 取代了粗暴的提取倒数第一行，改用正则表达式级的拦截过滤机制重构了 `suisuinian-brain-proxy.js`，保证只把纯净的，被 `{ }` 包裹的漂亮多说话人 JSON 数据返回给前端。
* **修复 /summarize 接口中不可饶恕的拼写错误**：
  * 及时修复了后端写错的一个 `filePath` 局部变量（应为 `audioPath`），成功拦截了一起 OpenClaw AI 总结在关键时刻“掉链子”的惨案。
